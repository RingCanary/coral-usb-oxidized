# Tensorizer Dense Template (Single FULLY_CONNECTED)

Date: 2026-02-21

Goal: move from multi-layer MobileNet patching to a single-op template where
the parameter blob is a single matrix-like payload.

## Why this path

- Single-op template removes layer-boundary ambiguity in parameter bytes.
- It directly tests instruction-stream reuse with controlled parameter edits.
- It is the shortest route toward a GEMM-style tensorizer loop.

## Toolchain compatibility finding

`edgetpu_compiler` accepted Dense templates generated by:

- `python 3.9`
- `tensorflow-cpu 2.10.1`
- `numpy 1.23.5`

The same template generated with newer TensorFlow (`2.18.0`) failed compiler
acceptance in this environment.

## End-to-end pipeline

Command:

```bash
./tools/dense_template_pipeline.sh --patch-mode zero
```

Primary artifact directory:

- `traces/dense-template-20260221T120206Z`

Generated artifacts:

- `dense_256x256_quant.tflite`
- `dense_256x256_quant_edgetpu.tflite`
- `dense_256x256_quant_edgetpu.log`
- `extract/metadata.json`
- `exec_parse.txt`
- `exec_parse.json`
- `tensorizer_inspect.txt`
- `tensorizer_inspect.json`
- `dense_256x256_quant_edgetpu_patched_zero.tflite`
- `patch_zero.json`

## Parsed executable layout

From `tensorizer_inspect.txt` + `exec_parse.txt`:

- Package count: `1`
- Executables: `2`
  - `exe[0]`: `EXECUTION_ONLY`, size `12288`
    - instruction chunk total: `4112`
    - parameters: `0`
  - `exe[1]`: `PARAMETER_CACHING`, size `73728`
    - instruction chunk total: `1072`
    - parameters: `65536`
    - parameter region: `[12584, 78120)` in compiled model file

Compiled model metrics:

- input dims: `1x256`
- output dims: `1x256`
- total ops: `1`
- EdgeTPU op mapping: `FULLY_CONNECTED = 1`

## Runtime validation

Environment:

```bash
eval "$(./tools/bootstrap_arch_stack.sh print-env)"
```

### Deterministic output dump (identity-like baseline)

Command:

```bash
cargo run --example inference_dump -- \
  traces/dense-template-20260221T120206Z/dense_256x256_quant_edgetpu.tflite ramp
```

Observed:

- output vector equals signed ramp `[-128..127]`
- confirms template behaves like expected near-identity mapping

### Patched outputs

Patched model outputs via `inference_dump`:

- `patched_zero`: output saturates near constant high values (`127`-dominant)
- `patched_ramp`: periodic transformed pattern
- `patched_xorff`: monotonic descending pattern

This confirms parameter edits alter compute behavior while execution remains
stable.

## Latency (EdgeTPU)

From `inference_benchmark` (`runs=30`, `warmup=5`):

- baseline: avg `0.210 ms` (`min=0.184`, `p95=0.242`)
- patched_zero: avg `0.210 ms` (`min=0.185`, `p95=0.255`)

Interpretation: payload mutation changes outputs without materially changing
transport/runtime envelope.

## USB syscall trace snapshots

Baseline:

- `traces/usb-syscall-20260221T120304Z/strace-usb-20260221T120304Z.summary.txt`
- `USBDEVFS_SUBMITURB=320`
- `USBDEVFS_REAPURBNDELAY=456`

Patched zero:

- `traces/usb-syscall-20260221T120317Z/strace-usb-20260221T120317Z.summary.txt`
- `USBDEVFS_SUBMITURB=320`
- `USBDEVFS_REAPURBNDELAY=466`

Control-path/submit counts remain effectively invariant; behavior differences
come from data payload content.

## Immediate next step for GEMM path

Recovered layout map and structured patch validation now live in:

- `docs/dense_layout_probe.md`
- `tools/dense_layout_probe.py`
- `tools/dense_template_matrix_patch.py`
- `tools/dense_quant_value_probe.py`

Next step for GEMM path:

1. Move from binary (`128`/`255`) payload patterns to calibrated multi-level
   quantized payload writes.
2. Add host-side dequantized expected-value checks for representative matrix
   blocks.
3. Wrap into a stable tensorizer API around template reuse.

## 2026-02-22 update: Rust-native tensorizer path

The template patch + execute loop is now available directly in crate code:

- `DenseGemmTemplate` for DWN1 parameter-region discovery and matrix patching
- `PreparedDenseGemm` for delegate-backed reuse from in-memory patched model bytes
- `dense_256_param_offset(row, col)` for the recovered 256x256 restride mapping
- `dense_param_offset(input_dim, output_dim, row, col)` for generalized dimensions

Reference example:

```bash
cargo run --example gemm_int8 -- \
  traces/dense-template-20260221T120206Z/dense_256x256_quant_edgetpu.tflite \
  shift_plus1 ramp
```

Dimension-aware Rust execution example:

```bash
cargo run --example gemm_int8_dynamic -- \
  traces/dense-template-1024x1024-20260222T062017Z/dense_1024x1024_quant_edgetpu.tflite \
  1024 1024 identity ramp 30
```

Bundled-template path (no external model file required):

```bash
cargo run --example gemm_int8_bundled -- 2688 identity 30
```

Row-tiled large output experiment (matrix footprint larger than a single
`2688x2688` parameter block):

```bash
cargo run --example gemm_tiled_rows -- 8192 identity_cycle 1
```

Prepared batch helper (host-loop over multiple input rows with interpreter
reuse):

- `PreparedDenseGemm::execute_batch_rows(&[i8]) -> Vec<i8>`

## 2026-02-22 update: dimension scaling sweep

Observed from pipeline runs (`warmup=1`, `runs=5`) with identity kernels:

| dim | avg ms | effective GMAC/s | on-chip params | off-chip params | executables |
|---:|---:|---:|---|---|---:|
| 256 | 0.225 | 0.291 | 64.00KiB | 0.00B | 2 |
| 512 | 0.264 | 0.993 | 256.00KiB | 0.00B | 2 |
| 1024 | 0.277 | 3.785 | 1.00MiB | 0.00B | 2 |
| 2048 | 0.474 | 8.849 | 4.00MiB | 0.00B | 2 |
| 2304 | 0.339 | 15.659 | 5.06MiB | 0.00B | 2 |
| 2688 | 0.449 | 16.092 | 6.89MiB | 0.00B | 2 |
| 2752 | 17.303 | 0.438 | 0.00B | 7.22MiB | 1 |
| 3072 | 21.442 | 0.440 | 0.00B | 9.00MiB | 1 |
| 4096 | 37.554 | 0.447 | 0.00B | 16.00MiB | 1 |

Key result:

- There is a sharp regime change between `2688` and `2752` where compiler output
  flips from two-executable (parameter-caching) to one-executable streaming.
- Past this point, throughput collapses from ~`16 GMAC/s` to ~`0.44 GMAC/s`,
  indicating parameter streaming dominates runtime.

Layout-map generalization checks:

- Single-hot probes for `512x512` and `1024x1024` exactly match
  `dense_param_offset(...)` (same 64x64 tile and 4-lane inner ordering).
