# Tensorizer Dense Template (Single FULLY_CONNECTED)

Date: 2026-02-21

Goal: move from multi-layer MobileNet patching to a single-op template where
the parameter blob is a single matrix-like payload.

## Why this path

- Single-op template removes layer-boundary ambiguity in parameter bytes.
- It directly tests instruction-stream reuse with controlled parameter edits.
- It is the shortest route toward a GEMM-style tensorizer loop.

## Toolchain compatibility finding

`edgetpu_compiler` accepted Dense templates generated by:

- `python 3.9`
- `tensorflow-cpu 2.10.1`
- `numpy 1.23.5`

The same template generated with newer TensorFlow (`2.18.0`) failed compiler
acceptance in this environment.

## End-to-end pipeline

Command:

```bash
./tools/dense_template_pipeline.sh --patch-mode zero
```

Primary artifact directory:

- `traces/dense-template-20260221T120206Z`

Generated artifacts:

- `dense_256x256_quant.tflite`
- `dense_256x256_quant_edgetpu.tflite`
- `dense_256x256_quant_edgetpu.log`
- `extract/metadata.json`
- `exec_parse.txt`
- `exec_parse.json`
- `tensorizer_inspect.txt`
- `tensorizer_inspect.json`
- `dense_256x256_quant_edgetpu_patched_zero.tflite`
- `patch_zero.json`

## Parsed executable layout

From `tensorizer_inspect.txt` + `exec_parse.txt`:

- Package count: `1`
- Executables: `2`
  - `exe[0]`: `EXECUTION_ONLY`, size `12288`
    - instruction chunk total: `4112`
    - parameters: `0`
  - `exe[1]`: `PARAMETER_CACHING`, size `73728`
    - instruction chunk total: `1072`
    - parameters: `65536`
    - parameter region: `[12584, 78120)` in compiled model file

Compiled model metrics:

- input dims: `1x256`
- output dims: `1x256`
- total ops: `1`
- EdgeTPU op mapping: `FULLY_CONNECTED = 1`

## Runtime validation

Environment:

```bash
eval "$(./tools/bootstrap_arch_stack.sh print-env)"
```

### Deterministic output dump (identity-like baseline)

Command:

```bash
cargo run --example inference_dump -- \
  traces/dense-template-20260221T120206Z/dense_256x256_quant_edgetpu.tflite ramp
```

Observed:

- output vector equals signed ramp `[-128..127]`
- confirms template behaves like expected near-identity mapping

### Patched outputs

Patched model outputs via `inference_dump`:

- `patched_zero`: output saturates near constant high values (`127`-dominant)
- `patched_ramp`: periodic transformed pattern
- `patched_xorff`: monotonic descending pattern

This confirms parameter edits alter compute behavior while execution remains
stable.

## Latency (EdgeTPU)

From `inference_benchmark` (`runs=30`, `warmup=5`):

- baseline: avg `0.210 ms` (`min=0.184`, `p95=0.242`)
- patched_zero: avg `0.210 ms` (`min=0.185`, `p95=0.255`)

Interpretation: payload mutation changes outputs without materially changing
transport/runtime envelope.

## USB syscall trace snapshots

Baseline:

- `traces/usb-syscall-20260221T120304Z/strace-usb-20260221T120304Z.summary.txt`
- `USBDEVFS_SUBMITURB=320`
- `USBDEVFS_REAPURBNDELAY=456`

Patched zero:

- `traces/usb-syscall-20260221T120317Z/strace-usb-20260221T120317Z.summary.txt`
- `USBDEVFS_SUBMITURB=320`
- `USBDEVFS_REAPURBNDELAY=466`

Control-path/submit counts remain effectively invariant; behavior differences
come from data payload content.

## Immediate next step for GEMM path

Recovered layout map and structured patch validation now live in:

- `docs/dense_layout_probe.md`
- `tools/dense_layout_probe.py`
- `tools/dense_template_matrix_patch.py`

Next step for GEMM path:

1. Move from binary (`128`/`255`) payload patterns to calibrated multi-level
   quantized payload writes.
2. Add host-side dequantized expected-value checks for representative matrix
   blocks.
3. Wrap into a stable tensorizer API around template reuse.
